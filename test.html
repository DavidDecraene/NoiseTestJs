<!DOCTYPE html>
<html>

<head>
  <title>NoiseTest</title>
  <link rel="stylesheet" type="text/css" href="css/main.css">
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script type="text/javascript" src="./js/simplex-noise.js"></script>
  <script type="text/javascript" src="./js/noise.samplers.js"></script>
  <script type="text/javascript" src="js/tinycolor.js"></script>
  <script type="text/javascript" src="./js/array2d.js"></script>
  <script type="text/javascript" src="./js/canvas.js"></script>
  <script type="text/javascript" src="./js/main.js"></script>
  <script type="text/javascript">
    /*jshint esversion: 9 */
    function handleCell(x, y, index, fn) {
      const coords = x + '_' + y;
      const cell = index[coords];
      if (cell) {
        fn(cell);
      }
    }

    function setTypeOne(cell) {
      if(cell.height <= 0) cell.type = 1;
    }

    $(document).ready(function() {
      const $canvas1 = $('#canvas1');
      let w = 256;
      let h = 256;
      const freq = 1 / 10;
      let pr = 0;
      const simplex = new SimplexSampler('test');
      const voronoi = new VoronoiSampler();
      const cellIndex = {};
      const center = new Vector2(w/2 * freq, h/2 * freq);
      let arr = new Array2D().forEach(w, h, (x, y, a) => {
        const cell = voronoi.voronoiCell(x * freq, y * freq);
        const coords = cell.v.x + '_' + cell.v.y;
        let existing = cellIndex[coords];
        if(!existing) {
          existing = { c: cell.c, v: cell.v, type: 0 };
          cellIndex[coords] = existing;
          if (cell.v.x <= 0 || cell.v.y <= 0) existing.type = 1;
          else  if (cell.v.x >= w  * freq  - 1 || cell.v.y >= h  * freq - 1) existing.type = 1;
          existing.noise = simplex.getNoise(cell.v.x, cell.v.y);
          const ratio = cell.v.distance(center) / center.x;
          const n = ((1 - ratio) * 2) - 1; // rescale from -1 to 1
          existing.height = existing.noise  + n + 1; // from -1 to 3
          existing.ratio = ratio;
        }
        const data = { d: cell.d, cell: existing } ;
        a.setData(x, y,data);
      });
      // For each point: if neighbour point cell != cell: link neighbour cell
      for (let i =0; i < 2; i++){
      arr.forEach(w, h, (x, y, a)  => {
        const data = a.getData(x, y);
        const cell = data.cell;
        if (cell.type == 1) {
          handleCell(cell.v.x + 1, cell.v.y, cellIndex, setTypeOne);
          handleCell(cell.v.x, cell.v.y + 1, cellIndex, setTypeOne);
          handleCell(cell.v.x - 1, cell.v.y, cellIndex, setTypeOne);
          handleCell(cell.v.x, cell.v.y - 1, cellIndex, setTypeOne);

          handleCell(cell.v.x + 1, cell.v.y + 1, cellIndex, setTypeOne);
          handleCell(cell.v.x - 1, cell.v.y + 1, cellIndex, setTypeOne);
          handleCell(cell.v.x - 1, cell.v.y - 1, cellIndex, setTypeOne);
          handleCell(cell.v.x + 1, cell.v.y - 1, cellIndex, setTypeOne);

        }
      });
    }
      arr.forEach(w, h, (x, y, a)  => {
        const data = a.getData(x, y);
        const cell = data.cell;
        let color;
        const isCenter = Math.abs(data.d) <= 0.1;
        if (isCenter) {
          color = tinycolor('red');
        } else  if(cell.type == 1) {
          color = tinycolor('blue');
        } else {
          // from 0 to 1
          if (cell.ratio > 0.8) {
            color = tinycolor('green');
          } else if(cell.height < 0){
            color = tinycolor('steelblue');

          } else {
            color = tinycolor.fromRatio({
              r: cell.noise,
              g: cell.noise,
              b: cell.noise
            });
          }
        }
        data.color = color;
      });
      console.log(cellIndex);
      new Canvas(4, {
        createElement: true,
        w,
        h
      }).appendTo($canvas1).draw(arr.values);

    });
  </script>
</head>

<body>
  <div id="canvas1" class="flex-stage">
    <p>Sample</p>
  </div>

</body>

</html>
